#!/usr/bin/env python

import argparse
import glob
import os
import os.path as osp
import platform
import re
import shlex
import subprocess

import cv2
import tqdm


class CvVideoWriter(object):

    def __init__(self, out, fps):
        if platform.uname()[0] == 'Darwin':
            self.fourcc = cv2.cv.CV_FOURCC(*'mp4v')
            self.out = out + '.mp4'
        else:
            self.fourcc = cv2.cv.CV_FOURCC(*'XVID')
            self.out = out + '.avi'
        self.fps = fps
        self._writer = None

    def write(self, stamp, frame):
        if self._writer is None:
            self._writer = cv2.VideoWriter(
                self.out, self.fourcc, self.fps,
                frameSize=(frame.shape[1], frame.shape[0]),
                isColor=frame.ndim == 3)
        self._writer.write(frame)

    def __del__(self):
        self._writer.release()


def natural_sort(l):
    convert = lambda text: int(text) if text.isdigit() else text.lower()  # NOQA
    alphanum_key = lambda key: [convert(c) for c in re.split('([0-9]+)', key)]  # NOQA
    return sorted(l, key=alphanum_key)


def main():
    parser = argparse.ArgumentParser()
    parser.add_argument('out_file')
    parser.add_argument('-i', '--input-files', default='*.jpg',
                        help="Input patterns like '*.jpg'")
    parser.add_argument('-r', '--rate', type=int, default=1)
    args = parser.parse_args()

    args.input_files = glob.glob(args.input_files)

    basename, ext = osp.splitext(args.out_file)

    if args.rate < 30:
        fps = ((30 // args.rate) + 1) * args.rate
    else:
        fps = args.rate
    writer = CvVideoWriter(basename, fps=fps)

    for f in tqdm.tqdm(natural_sort(args.input_files), ncols=80):
        frame = cv2.imread(f)
        for _ in xrange(fps // args.rate):
            writer.write(None, frame)

    out_file = writer.out
    if osp.splitext(writer.out)[1] == '.avi' and ext == '.mp4':
        cmd = 'avi_to_mp4 %s' % writer.out
        subprocess.call(shlex.split(cmd),
                        stdout=subprocess.PIPE, stderr=subprocess.PIPE)
        os.remove(writer.out)
        out_file = basename + ext

    print('==> Saved video to: %s' % out_file)


if __name__ == '__main__':
    main()
