#!/usr/bin/env python

from __future__ import print_function

import argparse
import os
import os.path as osp
import time

import pandas as pd


def print_bar(title='', width=80):
    if title:
        title = ' ' + title + ' '
    length = len(title)
    if length % 2 == 0:
        length_left = length_right = length / 2
    else:
        length_left = length // 2
        length_right = length - length_left
    print('=' * (width // 2 - 1 - length_left) +
          title + '=' * (width // 2 - length_right))


def main():
    parser = argparse.ArgumentParser()
    parser.add_argument('log_file')
    parser.add_argument('--all', action='store_true')
    args = parser.parse_args()

    log_file = args.log_file
    show_all = args.all

    pd.set_option('display.width', 200)
    pd.set_option('display.float_format', lambda x: '%.3f' % x)

    while True:
        try:
            ext = osp.splitext(log_file)[-1]
            if ext == '.json':
                df = pd.read_json(log_file)
            elif ext == '.csv':
                df = pd.read_csv(log_file)
            df = df.set_index(['epoch', 'iteration'])

            train_cols, valid_cols, else_cols = [], [], []
            for col in df.columns:
                if col.startswith('validation/') or col.startswith('valid/'):
                    valid_cols.append(col)
                elif col.startswith('train/'):
                    train_cols.append(col)
                else:
                    else_cols.append(col)

            if show_all:
                print(df.to_string())
                break

            width = len('  '.join(['epoch', 'iteration']) + '  '.join(train_cols) + '   ')

            print(chr(27) + "[2J")

            log_dir = osp.dirname(log_file)
            param_files = [osp.join(log_dir, f) for f in ['params.yaml', 'config.yaml']]
            exists = [osp.exists(f) for f in param_files]
            if any(exists):
                import yaml
                param_file = param_files[exists.index(True)]
                data = yaml.load(open(param_file))
                print_bar('params', width=width)
                print(yaml.safe_dump(data, default_flow_style=False))
                print_bar('', width=width)

            print('log_file: %s' % log_file)

            print_bar('train', width=width)
            print(df[train_cols].dropna().tail(n=5))
            print()

            print_bar('valid', width=width)
            print(df[valid_cols].dropna().tail(n=3))
            print()

            print_bar('min/mean/max', width=width)
            for cols in [train_cols, valid_cols]:
                split = osp.split(cols[0])[0]
                idx_min = df[osp.join(split, 'loss')].idxmin()
                idx_max = df[osp.join(split, 'loss')].idxmax()
                print(df.ix[idx_min][cols])
            print_bar(width=width)

            time.sleep(1)
        except KeyboardInterrupt:
            break
        except Exception as e:
            pass


if __name__ == '__main__':
    main()
