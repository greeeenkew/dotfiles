#!/usr/bin/env python

from __future__ import print_function

import argparse
import collections
import multiprocessing
import os.path as osp
import time
import warnings
warnings.filterwarnings('ignore')  # NOQA

from paramiko import AutoAddPolicy
from paramiko import SSHClient
from termcolor import colored
import yaml


def ssh_and_run(host, user, port, private_key, commands):
    ssh = SSHClient()
    ssh.set_missing_host_key_policy(AutoAddPolicy())
    n_retry = 3
    for i in range(n_retry):
        try:
            ssh.connect(host, port, user, key_filename=private_key)
            break
        except Exception:
            pass
    else:
        return
    outputs = []
    for cmd in commands:
        stdin, stdout, stderr = ssh.exec_command(cmd)
        output = stdout.read()
        outputs.append(output)
    ssh.close()
    return outputs


def main():
    parser = argparse.ArgumentParser()
    parser.add_argument('--no-color', action='store_true', help='Disable color output.')
    args = parser.parse_args()

    filename = osp.expanduser('~/.gpu_checker.cfg')

    with open(filename, 'r') as f:
        server_list = yaml.load(f)

    port = 22
    private_key = osp.expanduser('~/.ssh/id_rsa')
    user = server_list['username']
    hosts = server_list['hosts']

    cmds = [
        '$HOME/.local/bin/cuda-smi',
        '''ps auxwww | awk '{print $1}' | egrep "$(command ls /home)" | sort | uniq -c | sort -nr | xargs''',
        """grep 'cpu ' /proc/stat | awk '{usage=($2+$4)*100/($2+$4+$5)} END {print "CPU: " usage "%"}'""",
    ]

    pool = multiprocessing.Pool()
    processes = []
    for host in hosts:
        process = pool.apply_async(ssh_and_run, args=(host, user, port, private_key, cmds))
        processes.append((host, process))

    processes = collections.deque(processes)
    print('-' * 110)
    host_str_size = max(len(host) for host, _ in processes)
    while processes:
        host, process = processes.popleft()
        if process.ready():
            outputs = process.get()
            template_host = '{:<%ds}' % host_str_size
            host = template_host.format(host)
            if not args.no_color:
                host = colored(host, attrs=['bold'])
            if outputs:
                for output in outputs:
                    for line in output.splitlines():
                        print('{}: {}'.format(host, line))
            else:
                print('{}: Cannot connect.'.format(host))
            print('-' * 110)
        else:
            processes.append((host, process))
        time.sleep(0.01)


if __name__ == '__main__':
    main()
